name: ROS2 CI

on:
  push:
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Check if image exists
      id: image-check
      run: |
        if docker pull ghcr.io/${{ github.repository_owner }}/ros2_humble:latest; then
          echo "Image already exists"
          echo "::set-output name=image-exists::true"
        else
          echo "Image does not exist"
          echo "::set-output name=image-exists::false"
        fi

    - name: Build and push Docker image
      if: steps.image-check.outputs.image-exists == 'false'
      run: |
        docker build -t ghcr.io/${{ github.repository_owner }}/ros2_humble:latest .
        docker push ghcr.io/${{ github.repository_owner }}/ros2_humble:latest

  ros2_build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ros2_humble:latest
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up ROS2 workspace
      id: build_test
      run: |
        cd /root/ros2_ws/
        source /opt/ros/humble/setup.sh && colcon build
    - name: build_test command success
      if: steps.build_test.outcome == 'success'
      run: echo "result - success"
    - name: build_test command failure
      if: steps.build_test.outcome == 'failure'
      run: echo "result - failure" && exit 1
